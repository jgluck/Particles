<html>
<head>
<title>particles</title>
<link rel="icon" type="image/png" href="favicon.png">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucen">

<style>
body{
	background-color:#FFE7BD;
	margin:0px;	
	
	font-size:20px;
	
}
#container{
	width:100%;
	height:100%;
	background-color:#FFF1DB;
	
	-webkit-user-select: none;
 	-moz-user-select: none
}
.particle{
	position:absolute;
	background-color:#FE631C;
	-moz-border-radius: 100px;
	-webkit-border-radius: 100px;
	border-radius: 100px;
}
#message{
	font-family: Lucida Grande, Lucida, sans-serif;
	color:#882908;
	padding:10px;
}

</style>

<script>

var container;
var msgDiv;

var particles=[];

var gravityX=0;
var gravityY=.3;
var fricAir=.999;
var fricWall=.8;

//fricAir=1;
//fricWall=1;  		if(e.keyCode==88){ //x


var defRad=20;

var stepsize=1;

var mouseStart={x:0,y:0};

var dims={w:0,h:0};

var run=true;

var avgShake=0;

var fadeMsg=function(){
	
	if(msgDiv.style.opacity>.15){
	msgDiv.style.opacity=(msgDiv.style.opacity)-.05;
	}else{
		msgDiv.style.opacity=0;
	}
}

var message=function(msg){
	
	msgDiv.innerHTML=msg;
	
	msgDiv.style.opacity=4;
}


function Particle(x_,y_,vx_,vy_,r_){
	
	var density=.001;
	
	var div=document.createElement('div');
	div.className="particle";
	container.appendChild(div);

	var T=this;

	T.x=x_||0;
	T.y=y_||0;
	T.r=r_||10;
	
	T.vx=vx_||0;
	T.vy=vy_||0;
	
	//T.m=1;
	T.m=Math.PI*T.r*T.r*density;
	
	div.style.width=div.style.height=T.r*2+'px';


	this.doWalls=function(){
		
			if(T.x>=dims.w-T.r){
				T.x=dims.w-T.r;
				T.vx=T.vx*-1*fricWall;
			}
			if(T.y>=dims.h-T.r){
				T.y=dims.h-T.r;
				T.vy=T.vy*-1*fricWall;
			}		
			if(T.x<=T.r){
				T.x=T.r;
				T.vx=T.vx*-1*fricWall;
			}
			if(T.y<=T.r){
				T.y=T.r;
				T.vy=T.vy*-1*fricWall;
			}
			if(T.y==T.r){
				T.vx*=fricWall;
			}
	}
	
	this.doPhys=function(){

			this.vx+=gravityX;
			this.vy+=gravityY;
			
			T.vx*=fricAir;
			T.vy*=fricAir;
			
			T.x+=T.vx*stepsize;
			T.y+=T.vy*stepsize;
	}

	this.doCollide=function(p){
		
		var p1=this;
		var p2=p;
		
		var dx = p2.x-p1.x; //dist
		var dy = p2.y-p1.y;
		
		var dm=Math.dist(dx,dy); //dist mag

		if(dm<(p1.r+p2.r)){
			
			//alert(collision!);
									
			//we should do the force-sum thing
		
		
			//  vN = V dot a
			
		
			//var a=Math.atan2(p2.y-p1.y,p2.x-p1.x); //collision angle
			
			if(!dm)dm+=.001; //don't divide by 0 :)

			var dxu=dx/dm;  //dist unit
			var dyu=dy/dm;
			
			var vn1 = p1.vx*dxu + p1.vy*dyu;
			var vn2 = p2.vx*dxu + p2.vy*dyu;
									
			var vom=(vn2-vn1)/(p1.m+p2.m)*2;// v/m
			
			p1.vx+=vom*dxu*p2.m;
			p1.vy+=vom*dyu*p2.m;
			
			p2.vx-=vom*dxu*p1.m;
			p2.vy-=vom*dyu*p1.m;

						
			//uncollide
			var dma = dm-p1.r-p2.r//adjusted for radius

			p1.x+=(dma*dxu)/2;
			p1.y+=(dma*dyu)/2;
			
			p2.x-=(dma*dxu)/2;
			p2.y-=(dma*dyu)/2;

		}

	}

	this.update=function update(){
		div.style.left=this.x-this.r+'px';
		div.style.top=this.y-this.r+'px';
	}
	
	this.setR=function setR(r_){
		this.r=r_;
		div.style.width=this.r*2;
		div.style.height=this.r*2;		
	}
	
	this.remove=function(){
		
		container.removeChild(div);
		

	}
	
	this.setColor=function(newColor){
		div.style.backgroundColor=newColor;
	}
	
	this.doWalls();
	this.update();

	particles.push(this);
}



function step(){
	
	if(run){
		
		var i;
		
		for(i in particles) particles[i].doPhys();;
		
		//collisions!
		
		for(var i1 in particles){
			for(var i2=i1;i2<particles.length;i2++){
				if(i1!=i2){
					particles[i1].doCollide(particles[i2]);
				}
			}
		}
		
		var energy=0;
		for(var i in particles){
			var p=particles[i];
			var vel=Math.dist(p.vx,p.vy);
			energy+=vel*vel*p.m/2;
		}
		//message(energy);
		
		
		for(var i in particles){
			particles[i].doWalls();
			particles[i].update();
		}
		
	}
	
}

document.onmousedown=function mousedown(e){
	mouseStart.x=e.clientX;
	mouseStart.y=e.clientY;	
}
document.onmouseup=function mouseup(e){
	new Particle(e.clientX,e.clientY,(e.clientX-mouseStart.x)*.1,(e.clientY-mouseStart.y)*.1,defRad);
	
}

window.onresize=function resize(){
	dims.w=container.clientWidth;
	dims.h=container.clientHeight;
}


function handleOrientation(e){
	E=e;
	
	//message(e.x+', '+e.y);

	gravityX=e.x;
	gravityY=e.y;

}

window.addEventListener("devicemotion", function(event) {
          // Process event.acceleration, event.accelerationIncludingGravity,
          // event.rotationRate and event.interval
          
          avgShake=(avgShake*9+Math.dist(event.acceleration.x,event.acceleration.y,event.acceleration.z))/10;
          
         message(avgShake);
//          
//          document.body.style.backgroundColor="#"+parseInt(avgShake*16, 16)+"0000";

	if(avgShake>10){
		
				for(var i in particles){
					particles[i].remove();
				}
				particles=[];

	}
//          
      }, true);

window.addEventListener("MozOrientation", handleOrientation, true);

var E;

window.ondeviceorientation=function(e){
	
	E=e;
	
	//message(e.beta+', '+e.gamma);
	
	gravityY=e.beta/90;
	gravityX=e.gamma/90;
	
}

//
//window.ondevicemotion=function(e){
//	
//	//alert(e.accelleration);
//	
//	gravityX=e.accelerationIncludingGravity.x/5;
//	gravityY=-e.accelerationIncludingGravity.y/5;
//}


//this doesn't work right
touchMove=function(e){
	
	e.preventDefault();
	
	//message(e);
	
	
	var touch=e.changedTouches[0];
	
	new Particle(touch.clientX,touch.clientY,0,0,Math.random()*defRad/3*2+defRad/3);	
	
//	return false;
}

//var lastEvent;

function init(){
	
	document.onkeydown=function(e){
		//lastEvent=e;
		
		switch(e.keyCode){
			
			case 32: //space
				run=!run;
				break;
			case 75: //k
			
				var nParts=10;
				for(var i=1;i<nParts;i++){
					new Particle(  Math.random()*dims.w,
					               Math.random()*dims.h,
					               Math.random()*10-5,
					               Math.random()*10-5,
					               
					               Math.random()*defRad/3*2+defRad/3);
				}
				break;
			
			case 88: //x
				for(i in particles){
					particles[i].remove();
				}
				particles=[];

				break;
				
			case 66: //b
				new Particle(dims.w/2,dims.h/2,0,0,100)
				break;
				
			case 38: //up
				gravityY-=.1;
				showGravity();
				break;
			case 40: //down
				gravityY+=.1;
				showGravity();
				break;
			case 39: //right
				gravityX+=.1;
				showGravity();
				break;
			case 37: //left
				gravityX-=.1;
				showGravity();
				break;
		}
		
		//message(e.keyCode);
	}
	
	msgDiv=document.getElementById("message");

	container=document.getElementById("container");
	window.onresize();
	
	container.addEventListener("touchmove", touchMove, false);


	setInterval('step()',40);
	

	message("try K, space, X, drag, tilt, B, arrows");

	setInterval('fadeMsg()',250);
	

//	new Particle(  dims.w/3,dims.h/2, .01*dims.w/3,  .005*dims.h/2,defRad);
//	new Particle(2*dims.w/3,dims.h/2, -.01*dims.w/3,-.005*dims.h/2,defRad);
//	new Particle( dims.w/3,1.5*dims.h/2, .01*dims.w/3,-.004*dims.h/2,defRad);

//	particles[1].setColor("#F00");
	
//	new Particle(  dims.w/6*.5,dims.h/2, .05*dims.w/3,  0,defRad*1);
//	new Particle(  dims.w/6*1,dims.h/2, 0,  .0,defRad*1);
//	new Particle(  dims.w/6*2,dims.h/2, 0,  .0,defRad*1);
//	new Particle(  dims.w/6*3,dims.h/2, 0,  .0,defRad*1);
//	new Particle(  dims.w/6*4,dims.h/2, 0,  .0,defRad*1);
//	new Particle(  dims.w/6*5,dims.h/2, 0,  .0,defRad*1);

//
//	new Particle(  dims.w-defRad,dims.h-defRad, 0,  .0,defRad);
//	new Particle(  dims.w/3*2,dims.h-defRad*2.13, 10,  .0,defRad);
//	new Particle(  dims.w/3*2,dims.h-defRad-Math.sqrt((defRad*defRad)/2)*3/2, 10,  .0,defRad);

//var nParts=5;
//for(var i=1;i<nParts;i++){
//	
//	new Particle(  dims.w/nParts*(i+.25), dims.h/2,      0, dims.h*.02,defRad);
//
//	new Particle(  dims.w/2,             dims.h/nParts*(i-.25), dims.w*.02, 0, defRad);
//}
//
//

}

var showGravity=function(){
	message("gravity: "+gravityX.toFixed(2)+", "+gravityY.toFixed(2));
}

Math.dist=function(a,b){
	return Math.sqrt(a*a+b*b);
}

</script>

</head>
<body onload="init()">


<div id='container'>
	<div id='message'></div>

</div>

</body>
<html>